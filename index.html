<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <title>OpenAI Ερωτήσεις</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h2>Καλώς ήρθες, <span id="username">{{ username }}</span></h2>
    <label>Αλλαγή ψευδωνύμου: </label>
    <input type="text" id="name_input" value="{{ username }}">
    <button onclick="changeUsername()">Αλλαγή</button>

    <hr>
    <h3>Κάνε Ερώτηση</h3>
    <textarea id="question_input" rows="3" cols="50"></textarea><br>
    <label>
        <input type="checkbox" id="use_openai" onchange="toggleCategory()"> Χρήση OpenAI
    </label>
    <select id="category" style="display:none;">
        <option value="Γνώση">Γνώση</option>
        <option value="Γεωγραφία">Γεωγραφία</option>
        <option value="Γενική Ερώτηση">Γενική Ερώτηση</option>
        <option value="Άνω των 18">Άνω των 18</option>
    </select><br>
    <button onclick="submitQuestion()">Στείλε Ερώτηση</button>

    <hr>
    <h3>Ερωτήσεις & Απαντήσεις</h3>
    <div id="qa_section"></div>

    <script>
        let username = "{{ username }}";

        function changeUsername() {
            const newName = document.getElementById("name_input").value;
            if(newName.trim() !== "") {
                username = newName.trim();
                document.getElementById("username").innerText = username;
            }
        }

        function toggleCategory() {
            const useOpenAI = document.getElementById("use_openai").checked;
            document.getElementById("category").style.display = useOpenAI ? "inline" : "none";
        }

        function submitQuestion() {
            const question = document.getElementById("question_input").value;
            const useOpenAI = document.getElementById("use_openai").checked;
            const category = document.getElementById("category").value;

            if(question.trim() === "") return alert("Πρέπει να γράψεις μια ερώτηση.");

            $.ajax({
                url: "/submit_question",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    username: username,
                    question: question,
                    use_openai: useOpenAI,
                    category: category
                }),
                success: () => {
                    document.getElementById("question_input").value = "";
                }
            });
        }

        function fetchData() {
            $.get("/get_data", function(response){
                const section = document.getElementById("qa_section");
                section.innerHTML = "";
                response.forEach(item => {
                    const div = document.createElement("div");
                    div.style.borderBottom = "1px solid gray";
                    div.style.marginBottom = "5px";
                    div.innerHTML = `<strong>${item.username}</strong>: ${item.question}<br><em>${item.answer}</em>`;
                    section.appendChild(div);
                });
            });
        }

        // Ανάκτηση δεδομένων κάθε 2 δευτ.
        setInterval(fetchData, 2000);
        fetchData();
    </script>
</body>
</html>
